<!DOCTYPE html><html lang="en" class="scroll-smooth"> <head><meta charset="utf-8"><link rel="icon" type="image/jpg" href="/favicon.webp"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.16.5"><script lang="javascript">
    (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            "gtm.start": new Date().getTime(),
            event: "gtm.js",
        });
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-M6RFWPQD");
</script><meta name="title" content="M. Moeen - PostgreSQL in Node"><meta name="description" content="PostgreSQL is one of the most advanced RDBMS available. It has all the features any application could ever need. Here is how to use it in Node"><meta property="og:title" content="M. Moeen - PostgreSQL in Node"><meta property="og:description" content="PostgreSQL is one of the most advanced RDBMS available. It has all the features any application could ever need. Here is how to use it in Node"><meta property="og:image" content="https://moeenn.github.io/logo.webp"><meta property="og:url" content="https://moeenn.github.io/blogs/undefined"><meta property="og:site_name" content="M. Moeen - PostgreSQL in Node"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://moeenn.github.io/blogs/undefined"><meta property="twitter:title" content="M. Moeen - PostgreSQL in Node"><meta property="twitter:image" content="https://moeenn.github.io/logo.webp"><meta property="twitter:description" content="PostgreSQL is one of the most advanced RDBMS available. It has all the features any application could ever need. Here is how to use it in Node"><title>M. Moeen - PostgreSQL in Node</title><link rel="stylesheet" href="/assets/blogs.DyGxG2II.css"></head> <body class="text-black bg-stone-50 h-screen flex flex-col"> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M6RFWPQD" height="0" width="0" style="display:none;visibility:hidden">
	</iframe></noscript> <div class="container max-w-6xl mx-auto px-6 lg:px-10">  <nav> <div class="pt-8 pb-4 flex justify-between"> <a class="my-auto cursor-pointer" href="/#"> <span class="font-mono pb-1 pt-2 font-bold text-white bg-gray-900 px-3 py-1 rounded">M.M</span> </a> <div class="block md:hidden"> <div class="flex space-x-2"> <a href="https://github.com/moeenn" target="_blank" class="my-auto hover:bg-gray-200 transition-colors rounded-full h-10 w-10 inline-flex" title="Github"> <svg class="size-6 m-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"> <rect width="256" height="256" fill="none"></rect><path d="M119.83,56A52,52,0,0,0,76,32a51.92,51.92,0,0,0-3.49,44.7A49.28,49.28,0,0,0,64,104v8a48,48,0,0,0,48,48h48a48,48,0,0,0,48-48v-8a49.28,49.28,0,0,0-8.51-27.3A51.92,51.92,0,0,0,196,32a52,52,0,0,0-43.83,24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M104,232V192a32,32,0,0,1,32-32h0a32,32,0,0,1,32,32v40" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M104,208H72a32,32,0,0,1-32-32A32,32,0,0,0,8,144" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path> </svg> </a> <a href="https://www.linkedin.com/in/moeenn" target="_blank" class="my-auto hover:bg-gray-200 transition-colors rounded-full h-10 w-10 inline-flex" title="LinkedIn"> <svg class="size-6 m-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><rect x="32" y="32" width="192" height="192" rx="8" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></rect><line x1="120" y1="112" x2="120" y2="176" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line><line x1="88" y1="112" x2="88" y2="176" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line><path d="M120,140a28,28,0,0,1,56,0v36" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><circle cx="88" cy="84" r="12"></circle></svg> </a> <div data-navbutton class="hover:bg-gray-200 rounded p-2 cursor-pointer"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-700 h-6 w-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5"></path> </svg> </div> </div> </div> <div class="hidden md:flex md:space-x-2"> <a href="/#career" class="px-3 py-2 text-black text-sm my-auto border-b-2 border-transparent hover:border-black hover:bg-gray-200 rounded-t transition-colors"> Career </a><a href="/#projects" class="px-3 py-2 text-black text-sm my-auto border-b-2 border-transparent hover:border-black hover:bg-gray-200 rounded-t transition-colors"> Projects </a><a href="/#tools" class="px-3 py-2 text-black text-sm my-auto border-b-2 border-transparent hover:border-black hover:bg-gray-200 rounded-t transition-colors"> Skills &amp; Tools </a><a href="/#contact" class="px-3 py-2 text-black text-sm my-auto border-b-2 border-transparent hover:border-black hover:bg-gray-200 rounded-t transition-colors"> Contact Me </a> <a href="/blogs" class="px-3 py-2 font-bold text-black text-sm my-auto hover:bg-gray-200 border-b-2 border-transparent hover:border-black rounded-t transition-colors">
Blogs
</a> <div class="flex px-2"> <span class="my-auto text-gray-300">|</span> </div> <div class="flex space-x-2"> <a href="https://github.com/moeenn" target="_blank" class="my-auto hover:bg-gray-200 transition-colors rounded-full h-10 w-10 inline-flex" title="Github"> <svg class="size-6 m-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"> <rect width="256" height="256" fill="none"></rect><path d="M119.83,56A52,52,0,0,0,76,32a51.92,51.92,0,0,0-3.49,44.7A49.28,49.28,0,0,0,64,104v8a48,48,0,0,0,48,48h48a48,48,0,0,0,48-48v-8a49.28,49.28,0,0,0-8.51-27.3A51.92,51.92,0,0,0,196,32a52,52,0,0,0-43.83,24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M104,232V192a32,32,0,0,1,32-32h0a32,32,0,0,1,32,32v40" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M104,208H72a32,32,0,0,1-32-32A32,32,0,0,0,8,144" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path> </svg> </a> <a href="https://www.linkedin.com/in/moeenn" target="_blank" class="my-auto hover:bg-gray-200 transition-colors rounded-full h-10 w-10 inline-flex" title="LinkedIn"> <svg class="size-6 m-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><rect x="32" y="32" width="192" height="192" rx="8" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></rect><line x1="120" y1="112" x2="120" y2="176" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line><line x1="88" y1="112" x2="88" y2="176" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line><path d="M120,140a28,28,0,0,1,56,0v36" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><circle cx="88" cy="84" r="12"></circle></svg> </a> </div> </div> </div> <div data-mobilemenu class="hidden"> <div class="flex flex-col md:hidden bg-gray-100 rounded"> <a href="/#career" class="px-3 py-4 text-black leading-none hover:bg-gray-300 text-sm my-auto transition-colors mb-0 rounded"> Career </a><a href="/#projects" class="px-3 py-4 text-black leading-none hover:bg-gray-300 text-sm my-auto transition-colors mb-0 rounded"> Projects </a><a href="/#tools" class="px-3 py-4 text-black leading-none hover:bg-gray-300 text-sm my-auto transition-colors mb-0 rounded"> Skills &amp; Tools </a><a href="/#contact" class="px-3 py-4 text-black leading-none hover:bg-gray-300 text-sm my-auto transition-colors mb-0 rounded"> Contact Me </a> <a href="/blogs" class="px-3 py-4 text-black leading-none hover:bg-gray-300 text-sm my-auto transition-colors mb-0 rounded">
Blogs
</a> </div> </div> </nav> <script src="/scripts/navbar.js" defer></script>  </div> <main class="flex-1">  <div class="container max-w-6xl mx-auto px-6 lg:px-10">  <div class="pt-8 pb-14"> <div class="pb-8"> <a href="/blogs" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-full inline-flex space-x-2"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 my-auto"> <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path> </svg> <span class="my-auto leading-none">Back</span></a> </div> <h2 class="text-2xl space-x-2 mb-4"> <span class="font-normal text-gray-500">#</span> <span class="text-gray-900">PostgreSQL in Node</span> </h2> <div class="flex flex-wrap gap-2 mb-6"> <span class="border-r-2 border-stone-300 pr-4 mr-2 text-sm my-auto text-stone-700"> December 25, 2025 </span> <span class="text-xs bg-gray-200 hover:bg-gray-300 rounded px-2 py-1"> Javascript </span> <span class="text-xs bg-gray-200 hover:bg-gray-300 rounded px-2 py-1"> Database </span><span class="text-xs bg-gray-200 hover:bg-gray-300 rounded px-2 py-1"> Typescript </span><span class="text-xs bg-gray-200 hover:bg-gray-300 rounded px-2 py-1"> SQL </span><span class="text-xs bg-gray-200 hover:bg-gray-300 rounded px-2 py-1"> Node </span> </div> <div class="grid grid-cols-1 xl:grid-cols-4"> <div class="xl:order-last xl:pl-6 h-full"> <div class="xl:sticky xl:top-4"> <p class="font-medium text-gray-700 mb-2">
Table of content
</p> <a data-level="2" href="#installing-dependencies" style="margin-left: 0rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Installing dependencies </a><a data-level="3" href="#setting-up-useful-scripts-in-packagejson" style="margin-left: 0.75rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Setting up useful scripts in package.json </a><a data-level="2" href="#defining-and-running-migrations" style="margin-left: 0rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Defining and running migrations </a><a data-level="2" href="#basic-example" style="margin-left: 0rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Basic example </a><a data-level="3" href="#named-queries" style="margin-left: 0.75rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Named queries </a><a data-level="3" href="#define-entities-and-repositories" style="margin-left: 0.75rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Define entities and repositories </a><a data-level="3" href="#crud-example" style="margin-left: 0.75rem" class="block text-sm pb-1 hover:underline underline-offset-4"> CRUD example </a><a data-level="3" href="#transactions" style="margin-left: 0.75rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Transactions </a><a data-level="2" href="#conclusion" style="margin-left: 0rem" class="block text-sm pb-1 hover:underline underline-offset-4"> Conclusion </a> </div> </div> <div class="xl:order-first xl:col-span-3 prose-xl prose-p:leading-relaxed prose-p:text-base prose-li:leading-relaxed prose-li:text-base prose-li:p-0 prose-li:my-1 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-h4:text-lg prose-h4:text-md prose-headings:mb-2 prose-headings:mt-12 prose-headings:scroll-mt-4 prose-pre:mt-2 prose-pre:text-base prose-pre:leading-6 prose-ul:list-disc prose-table:border prose-table:border-gray-300 prose-table:w-full prose-table:mb-10 prose-tr:border prose-tr:border-gray-300 prose-th:border-x prose-th:border-gray-300 prose-th:py-1 prose-th:bg-gray-100 prose-td:border-x prose-td:border-gray-300 prose-td:py-1"> <p class="mt-8 xl:mt-0">PostgreSQL is one of the most advanced RDBMS available. It has all the features any application could ever need. Here is how to use it in Node</p> <h2 id="installing-dependencies">Installing dependencies</h2>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#FFCB6B">$</span><span style="color:#C3E88D"> npm</span><span style="color:#C3E88D"> i</span><span style="color:#C3E88D"> pg</span></span>
<span class="line"><span style="color:#FFCB6B">$</span><span style="color:#C3E88D"> npm</span><span style="color:#C3E88D"> i</span><span style="color:#C3E88D"> -D</span><span style="color:#C3E88D"> @types/pg</span><span style="color:#C3E88D"> node-pg-migrate</span><span style="color:#C3E88D"> dotenv</span></span></code></pre>
<p><strong>Note</strong>: <code>dotenv</code> is an indirect dependency of <code>node-pg-migrate</code>. It is required because we will be loading database URL from <code>.env</code> file</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># dont change name; this is automatically picked up by node-pg-migrate</span></span>
<span class="line"><span>DATABASE_URL=postgres://devuser:devpass@localhost:5432/dev</span></span></code></pre>
<h3 id="setting-up-useful-scripts-in-packagejson">Setting up useful scripts in <code>package.json</code></h3>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF">	"</span><span style="color:#C792EA">scripts</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">		"</span><span style="color:#FFCB6B">db:migrate</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">node-pg-migrate --envPath=.env up</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#89DDFF">		"</span><span style="color:#FFCB6B">db:migration</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">node-pg-migrate create -j sql</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#89DDFF">	}</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<p><strong>Note</strong>: By default, all migrations will be placed inside <code>migrations</code> directory.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#676E95;font-style:italic"># create file for a new migration</span></span>
<span class="line"><span style="color:#FFCB6B">npm</span><span style="color:#C3E88D"> run</span><span style="color:#C3E88D"> db:migration</span><span style="color:#89DDFF"> &#x3C;</span><span style="color:#C3E88D">migration_nam</span><span style="color:#BABED8">e</span><span style="color:#89DDFF">></span></span></code></pre>
<h2 id="defining-and-running-migrations">Defining and running migrations</h2>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#676E95;font-style:italic">-- Up Migration</span></span>
<span class="line"><span style="color:#F78C6C">create</span><span style="color:#F78C6C"> type</span><span style="color:#82AAFF"> user_role</span><span style="color:#F78C6C"> as</span><span style="color:#BABED8"> enum(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">admin</span><span style="color:#89DDFF">'</span><span style="color:#BABED8">, </span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">user</span><span style="color:#89DDFF">'</span><span style="color:#BABED8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C">create</span><span style="color:#F78C6C"> table</span></span>
<span class="line"><span style="color:#BABED8">  users (</span></span>
<span class="line"><span style="color:#BABED8">    id uuid</span></span>
<span class="line"><span style="color:#BABED8">    , email </span><span style="color:#C792EA">text</span><span style="color:#F78C6C"> not null</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#F78C6C">password</span><span style="color:#C792EA"> text</span><span style="color:#F78C6C"> not null</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#F78C6C">role</span><span style="color:#BABED8"> user_role </span><span style="color:#F78C6C">not null</span><span style="color:#C792EA"> default</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">user</span><span style="color:#89DDFF">'</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">isActive</span><span style="color:#89DDFF">"</span><span style="color:#C792EA"> boolean</span><span style="color:#F78C6C"> not null</span><span style="color:#C792EA"> default</span><span style="color:#BABED8"> true</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">createdAt</span><span style="color:#89DDFF">"</span><span style="color:#C792EA"> timestamp</span><span style="color:#F78C6C"> not null</span><span style="color:#C792EA"> default</span><span style="color:#F78C6C"> now</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">deletedAt</span><span style="color:#89DDFF">"</span><span style="color:#C792EA"> timestamp</span><span style="color:#F78C6C"> null</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#C792EA">primary key</span><span style="color:#BABED8"> (id)</span></span>
<span class="line"><span style="color:#BABED8">    , </span><span style="color:#C792EA">constraint</span><span style="color:#BABED8"> email_unique </span><span style="color:#F78C6C">unique</span><span style="color:#BABED8"> (email)</span></span>
<span class="line"><span style="color:#BABED8">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">-- Down Migration</span></span>
<span class="line"><span style="color:#F78C6C">drop</span><span style="color:#F78C6C"> table</span><span style="color:#BABED8"> users;</span></span>
<span class="line"><span style="color:#F78C6C">drop</span><span style="color:#F78C6C"> type</span><span style="color:#BABED8"> user_role;</span></span></code></pre>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#676E95;font-style:italic"># apply the migration</span></span>
<span class="line"><span style="color:#FFCB6B">npm</span><span style="color:#C3E88D"> run</span><span style="color:#C3E88D"> db:migrate</span></span></code></pre>
<h2 id="basic-example">Basic example</h2>
<p>The following basic code will get us started.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#89DDFF"> {</span><span style="color:#BABED8"> Pool</span><span style="color:#89DDFF"> }</span><span style="color:#89DDFF;font-style:italic"> from</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">pg</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> assert </span><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">node:assert/strict</span><span style="color:#89DDFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> DatabaseConfig</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> url</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">env</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Record</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">string</span><span style="color:#89DDFF">,</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">></span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> NodeJS</span><span style="color:#89DDFF">.</span><span style="color:#FFCB6B">ProcessEnv</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> conn</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> env</span><span style="color:#F07178">[</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">DATABASE_URL</span><span style="color:#89DDFF">"</span><span style="color:#F07178">]</span></span>
<span class="line"><span style="color:#82AAFF">        assert</span><span style="color:#F07178">(</span><span style="color:#BABED8">conn</span><span style="color:#89DDFF"> !=</span><span style="color:#89DDFF"> undefined</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">url</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> conn</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    #pool</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Pool</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">config</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> DatabaseConfig</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Pool</span><span style="color:#F07178">(</span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#F07178">            connectionString</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> config</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">url</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> ping</span><span style="color:#89DDFF">():</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">boolean</span><span style="color:#89DDFF">></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> result</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">select 1</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#BABED8"> result</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">rowCount</span><span style="color:#89DDFF"> ==</span><span style="color:#F78C6C"> 1</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    get</span><span style="color:#F07178"> conn</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#82AAFF">        assert</span><span style="color:#F07178">(</span><span style="color:#89DDFF">this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF"> !=</span><span style="color:#89DDFF"> null</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> disconnect</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">end</span><span style="color:#F07178">()</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">async</span><span style="color:#C792EA"> function</span><span style="color:#82AAFF"> main</span><span style="color:#89DDFF">():</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">void</span><span style="color:#89DDFF">></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> dbConfig</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> DatabaseConfig</span><span style="color:#F07178">(</span><span style="color:#BABED8">process</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">env</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Database</span><span style="color:#F07178">(</span><span style="color:#BABED8">dbConfig</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#82AAFF">    assert</span><span style="color:#F07178">(</span><span style="color:#89DDFF;font-style:italic">await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">ping</span><span style="color:#F07178">())</span></span>
<span class="line"><span style="color:#BABED8">    console</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">log</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">-- connection established --</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">disconnect</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#BABED8">    console</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">log</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">-- disconnected --</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF">main</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">catch</span><span style="color:#BABED8">(console</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">error)</span></span></code></pre>
<p>Above code is a bit too basic. Notably, it is missing the following functionalities:</p>
<ol>
<li>Named query support</li>
<li>Better transactions</li>
</ol>
<p>Let’s add these in.</p>
<h3 id="named-queries">Named queries</h3>
<p>So why do we even need named queries? Look at the following code which you will generally find with <code>pg</code>.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#C792EA">async</span><span style="color:#C792EA"> function</span><span style="color:#82AAFF"> createUser</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> user</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> query</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> `</span></span>
<span class="line"><span style="color:#C3E88D">        insert into users (id, email, password, role, "isActive", "createdAt")</span></span>
<span class="line"><span style="color:#C3E88D">        values ($1, $2, $3, $4, $5, $6)</span></span>
<span class="line"><span style="color:#89DDFF">    `</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">conn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#F07178"> [</span></span>
<span class="line"><span style="color:#BABED8">        user</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">id</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8">        user</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">email</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8">        user</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">password</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8">        user</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">role</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8">        user</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">isActive</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8">        user</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">createdAt</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    ])</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<p>The above code gives me anxiety. It is very error-prone and not at all fun to work with. We can do better. With named queries, the above code will look as follows.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#C792EA">async</span><span style="color:#C792EA"> function</span><span style="color:#82AAFF"> createUser</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> user</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> query</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> `</span></span>
<span class="line"><span style="color:#C3E88D">        insert into users (id, email, password, role, "isActive", "createdAt")</span></span>
<span class="line"><span style="color:#C3E88D">        values (:id, :email, :password, :role, :isActive, :createdAt)</span></span>
<span class="line"><span style="color:#89DDFF">    `</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">conn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> user</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<p>There. That’s much better. Now lets implement it.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#C792EA">interface</span><span style="color:#FFCB6B"> Stringable</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    toString</span><span style="color:#89DDFF">():</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> type</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">    [</span><span style="color:#BABED8;font-style:italic">x</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#BABED8">]</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Stringable</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> Date</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> null</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> type</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#89DDFF"> =</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> NamedQueryResult</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> preparedQuery</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> params</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#BABED8">[]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">preparedQuery</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> params</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">preparedQuery</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> preparedQuery</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">params</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> params</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> MissingArgumentError</span><span style="color:#C792EA"> extends</span><span style="color:#FFCB6B"> Error</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> arg</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">arg</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">        super</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">missing sql query argument: </span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#BABED8"> arg</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">arg</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> arg</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">function</span><span style="color:#82AAFF"> namedArray</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">values</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> offset</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> number</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> pieces</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#F07178">[] </span><span style="color:#89DDFF">=</span><span style="color:#F07178"> []</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    for</span><span style="color:#F07178"> (</span><span style="color:#C792EA">let</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF"> =</span><span style="color:#F78C6C"> 0</span><span style="color:#89DDFF">;</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF"> &#x3C;</span><span style="color:#BABED8"> values</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">length</span><span style="color:#89DDFF">;</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF">++</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#BABED8">        pieces</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">$</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">offset </span><span style="color:#89DDFF">+</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF">}`</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> pieces</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">join</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">, </span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> function</span><span style="color:#82AAFF"> named</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> NamedQueryResult</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> params</span><span style="color:#89DDFF"> =</span><span style="color:#F07178"> [</span><span style="color:#89DDFF">...</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">matchAll</span><span style="color:#F07178">(</span><span style="color:#89DDFF">/</span><span style="color:#C3E88D">:</span><span style="color:#89DDFF">([</span><span style="color:#C3E88D">a-zA-Z_</span><span style="color:#89DDFF">][</span><span style="color:#C3E88D">a-zA-Z0-9_</span><span style="color:#89DDFF">]*)/</span><span style="color:#F78C6C">g</span><span style="color:#F07178">)]</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">map</span><span style="color:#F07178">(</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">match</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =></span></span>
<span class="line"><span style="color:#BABED8">        match</span><span style="color:#F07178">[</span><span style="color:#F78C6C">0</span><span style="color:#F07178">]</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">slice</span><span style="color:#F07178">(</span><span style="color:#F78C6C">1</span><span style="color:#F07178">)</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> paramsSet</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Set</span><span style="color:#F07178">(</span><span style="color:#BABED8">params</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> paramArray</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#F07178">[] </span><span style="color:#89DDFF">=</span><span style="color:#F07178"> []</span></span>
<span class="line"><span style="color:#C792EA">    let</span><span style="color:#BABED8"> idx</span><span style="color:#89DDFF"> =</span><span style="color:#F78C6C"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    for</span><span style="color:#F07178"> (</span><span style="color:#C792EA">const</span><span style="color:#BABED8"> param</span><span style="color:#89DDFF"> of</span><span style="color:#BABED8"> paramsSet</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> paramValue</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> args</span><span style="color:#F07178">[</span><span style="color:#BABED8">param</span><span style="color:#F07178">]</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> ===</span><span style="color:#89DDFF"> undefined</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            throw</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> MissingArgumentError</span><span style="color:#F07178">(</span><span style="color:#BABED8">param</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">Array</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">isArray</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#F07178">)) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#C792EA">            const</span><span style="color:#BABED8"> replaceValue</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> namedArray</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> idx</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#BABED8">            query</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">replaceAll</span><span style="color:#F07178">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">:</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">param</span><span style="color:#89DDFF">}`</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> replaceValue</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#BABED8">            paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#89DDFF">...</span><span style="color:#BABED8">paramValue</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#BABED8">            idx</span><span style="color:#89DDFF"> +=</span><span style="color:#BABED8"> paramValue</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">length</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            continue</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">        query</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">replaceAll</span><span style="color:#F07178">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">:</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">param</span><span style="color:#89DDFF">}`</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> `</span><span style="color:#C3E88D">$</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">idx</span><span style="color:#89DDFF">}`</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> ===</span><span style="color:#89DDFF"> null</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#BABED8">            paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#89DDFF">null</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> !=</span><span style="color:#89DDFF"> null</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> instanceof</span><span style="color:#FFCB6B"> Date</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#BABED8">                paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">toISOString</span><span style="color:#F07178">())</span></span>
<span class="line"><span style="color:#89DDFF">            }</span><span style="color:#89DDFF;font-style:italic"> else</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">                paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">toString</span><span style="color:#F07178">())</span></span>
<span class="line"><span style="color:#89DDFF">            }</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">        idx</span><span style="color:#89DDFF">++</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> NamedQueryResult</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">trim</span><span style="color:#F07178">()</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> paramArray</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<p>We will also update the <code>Database</code> class as follows:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">	...</span></span>
<span class="line"><span style="color:#C792EA">	async</span><span style="color:#F07178"> namedQuery</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> named</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> args</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">preparedQuery</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">params</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<h3 id="define-entities-and-repositories">Define entities and repositories</h3>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#89DDFF"> {</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF"> }</span><span style="color:#89DDFF;font-style:italic"> from</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">zod</span><span style="color:#89DDFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">const</span><span style="color:#BABED8"> UserEntitySchema </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">object</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#F07178">    id</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">uuid</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    email</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">email</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    password</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">string</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    role</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">enum</span><span style="color:#BABED8">([</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">admin</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">user</span><span style="color:#89DDFF">"</span><span style="color:#BABED8">])</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    isActive</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">boolean</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    createdAt</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">date</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    deletedAt</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> z</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">date</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">nullable</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#89DDFF">}</span><span style="color:#BABED8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">type</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF"> =</span><span style="color:#FFCB6B"> z</span><span style="color:#89DDFF">.</span><span style="color:#FFCB6B">infer</span><span style="color:#89DDFF">&#x3C;typeof</span><span style="color:#BABED8"> UserEntitySchema</span><span style="color:#89DDFF">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> UserRepo</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    handleConstraintViolations</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">err</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> DatabaseError</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        switch</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">constraint</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            case</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">email_unique</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">                throw</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Error</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">email address already in use</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    #createUserQuery</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> `</span></span>
<span class="line"><span style="color:#C3E88D">        insert into users (id, email, password, role, "isActive", "createdAt")</span></span>
<span class="line"><span style="color:#C3E88D">        values (:id, :email, :password, :role, :isActive, :createdAt)</span></span>
<span class="line"><span style="color:#89DDFF">    `</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> createUser</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> user</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        try</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">namedQuery</span><span style="color:#F07178">(</span><span style="color:#89DDFF">this.</span><span style="color:#BABED8">#createUserQuery</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> user</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#89DDFF;font-style:italic"> catch</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#89DDFF"> instanceof</span><span style="color:#FFCB6B"> DatabaseError</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF">                this.</span><span style="color:#82AAFF">handleConstraintViolations</span><span style="color:#F07178">(</span><span style="color:#BABED8">err</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">            }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            throw</span><span style="color:#BABED8"> err</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    #findByIdQuery</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> `</span></span>
<span class="line"><span style="color:#C3E88D">        select * from users</span></span>
<span class="line"><span style="color:#C3E88D">        where id = :id</span></span>
<span class="line"><span style="color:#C3E88D">        limit 1</span></span>
<span class="line"><span style="color:#89DDFF">    `</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> findById</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> id</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">UserEntity</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> null</span><span style="color:#89DDFF">></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> result</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">namedQuery</span><span style="color:#F07178">(</span><span style="color:#89DDFF">this.</span><span style="color:#BABED8">#findByIdQuery</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> {</span><span style="color:#BABED8"> id</span><span style="color:#89DDFF"> }</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">result</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">rowCount</span><span style="color:#89DDFF"> ===</span><span style="color:#F78C6C"> 0</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            return</span><span style="color:#89DDFF"> null</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#BABED8"> UserEntitySchema</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">parse</span><span style="color:#F07178">(</span><span style="color:#BABED8">result</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">rows</span><span style="color:#F07178">[</span><span style="color:#F78C6C">0</span><span style="color:#F07178">])</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    #updateUserQuery</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> `</span></span>
<span class="line"><span style="color:#C3E88D">        update users</span></span>
<span class="line"><span style="color:#C3E88D">        set email = :email,</span></span>
<span class="line"><span style="color:#C3E88D">            password = :password,</span></span>
<span class="line"><span style="color:#C3E88D">            role = :role,</span></span>
<span class="line"><span style="color:#C3E88D">            "isActive" = :isActive,</span></span>
<span class="line"><span style="color:#C3E88D">            "createdAt" = :createdAt,</span></span>
<span class="line"><span style="color:#C3E88D">            "deletedAt" = :deletedAt</span></span>
<span class="line"><span style="color:#C3E88D">        where id = :id        </span></span>
<span class="line"><span style="color:#89DDFF">    `</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> updateUser</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> user</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        try</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">namedQuery</span><span style="color:#F07178">(</span><span style="color:#89DDFF">this.</span><span style="color:#BABED8">#updateUserQuery</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> user</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#89DDFF;font-style:italic"> catch</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#89DDFF"> instanceof</span><span style="color:#FFCB6B"> DatabaseError</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF">                this.</span><span style="color:#82AAFF">handleConstraintViolations</span><span style="color:#F07178">(</span><span style="color:#BABED8">err</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">            }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            throw</span><span style="color:#BABED8"> err</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    #deleteUserQuery</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> `</span></span>
<span class="line"><span style="color:#C3E88D">        delete from users</span></span>
<span class="line"><span style="color:#C3E88D">        where id = :id</span></span>
<span class="line"><span style="color:#89DDFF">    `</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> deleteUser</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Database</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> id</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        await</span><span style="color:#BABED8"> db</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">namedQuery</span><span style="color:#F07178">(</span><span style="color:#89DDFF">this.</span><span style="color:#BABED8">#deleteUserQuery</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> {</span><span style="color:#BABED8"> id</span><span style="color:#89DDFF"> }</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<h3 id="crud-example">CRUD example</h3>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#676E95;font-style:italic">// create user.</span></span>
<span class="line"><span style="color:#C792EA">const</span><span style="color:#BABED8"> newUser</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">	id</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> crypto</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">randomUUID</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">toString</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	email</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">admin@site.com</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	password</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">my-strong-password</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	role</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">admin</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	isActive</span><span style="color:#89DDFF">:</span><span style="color:#FF9CAC"> true</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	createdAt</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Date</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	deletedAt</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> null,</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">await</span><span style="color:#BABED8"> userRepo</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">createUser</span><span style="color:#BABED8">(db</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> newUser)</span></span></code></pre>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#676E95;font-style:italic">// update user.</span></span>
<span class="line"><span style="color:#C792EA">const</span><span style="color:#BABED8"> updatedUser</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">	id</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">d5b05464-6719-4061-bee1-b782898d6a3c</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	email</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">admin-updated@site.com</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	password</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">my-strong-password</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	role</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">admin</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	isActive</span><span style="color:#89DDFF">:</span><span style="color:#FF9CAC"> false</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	createdAt</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Date</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">	deletedAt</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> null,</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">await</span><span style="color:#BABED8"> userRepo</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">updateUser</span><span style="color:#BABED8">(db</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> updatedUser)</span></span></code></pre>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#676E95;font-style:italic">// find user.</span></span>
<span class="line"><span style="color:#C792EA">const</span><span style="color:#BABED8"> foundUser </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#BABED8"> userRepo</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">findById</span><span style="color:#BABED8">(db</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">d5b05464-6719-4061-bee1-b782898d6a3c</span><span style="color:#89DDFF">"</span><span style="color:#BABED8">)</span></span></code></pre>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#676E95;font-style:italic">// delete user.</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">await</span><span style="color:#BABED8"> userRepo</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">deleteUser</span><span style="color:#BABED8">(db</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">d5b05464-6719-4061-bee1-b782898d6a3c</span><span style="color:#89DDFF">"</span><span style="color:#BABED8">)</span></span></code></pre>
<h3 id="transactions">Transactions</h3>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> interface</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    query</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> values</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> any</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span></span>
<span class="line"><span style="color:#F07178">    namedQuery</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> Transaction</span><span style="color:#C792EA"> implements</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    #client</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> PoolClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">client</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> PoolClient</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> client</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> commit</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">commit</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> rollback</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">rollback</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    release</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">release</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    query</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> values</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> any</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> values</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    namedQuery</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> named</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> args</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">preparedQuery</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">params</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<p>We will update the <code>Database</code> class and add the following method for initiating transactions.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> Database</span><span style="color:#C792EA"> implements</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">	...</span></span>
<span class="line"><span style="color:#C792EA">	async</span><span style="color:#F07178"> transaction</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">callback</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">tx</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Transaction</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =></span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">void</span><span style="color:#89DDFF">>)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> handle</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">connect</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        await</span><span style="color:#BABED8"> handle</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">begin</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> tx</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Transaction</span><span style="color:#F07178">(</span><span style="color:#BABED8">handle</span><span style="color:#F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        try</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#82AAFF"> callback</span><span style="color:#F07178">(</span><span style="color:#BABED8">tx</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#BABED8"> tx</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">commit</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#89DDFF;font-style:italic"> catch</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#BABED8"> tx</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">rollback</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            throw</span><span style="color:#BABED8"> err</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#89DDFF;font-style:italic"> finally</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">            tx</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">release</span><span style="color:#F07178">()</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<p>Our <code>Database</code> and <code>Transaction</code> classes both implement the <code>IDatabase</code> interface. This means, now we can define our repository methods to be able to accept both <code>Database</code> and <code>Transaction</code> types.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> UserRepo</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">    ...</span></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> createUser</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">db</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> user</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> UserEntity</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        ...</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">    ...</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>The abstractions we have created now look like this.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#89DDFF"> {</span><span style="color:#BABED8"> Pool</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF;font-style:italic"> type</span><span style="color:#BABED8"> PoolClient</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF;font-style:italic"> type</span><span style="color:#BABED8"> QueryResult</span><span style="color:#89DDFF"> }</span><span style="color:#89DDFF;font-style:italic"> from</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">pg</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> assert </span><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">node:assert/strict</span><span style="color:#89DDFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">interface</span><span style="color:#FFCB6B"> Stringable</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    toString</span><span style="color:#89DDFF">():</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">type</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">    [</span><span style="color:#BABED8;font-style:italic">x</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#BABED8">]</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Stringable</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> Date</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> null</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"><span style="color:#C792EA">type</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#89DDFF"> =</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> NamedQueryResult</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> preparedQuery</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> params</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#BABED8">[]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">preparedQuery</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> params</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">preparedQuery</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> preparedQuery</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">params</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> params</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> MissingArgumentError</span><span style="color:#C792EA"> extends</span><span style="color:#FFCB6B"> Error</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> arg</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">arg</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">        super</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">missing sql query argument: </span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#BABED8"> arg</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">arg</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> arg</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">function</span><span style="color:#82AAFF"> namedArray</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">values</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> offset</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> number</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> pieces</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#F07178">[] </span><span style="color:#89DDFF">=</span><span style="color:#F07178"> []</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    for</span><span style="color:#F07178"> (</span><span style="color:#C792EA">let</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF"> =</span><span style="color:#F78C6C"> 0</span><span style="color:#89DDFF">;</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF"> &#x3C;</span><span style="color:#BABED8"> values</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">length</span><span style="color:#89DDFF">;</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF">++</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#BABED8">        pieces</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">$</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">offset </span><span style="color:#89DDFF">+</span><span style="color:#BABED8"> i</span><span style="color:#89DDFF">}`</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> pieces</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">join</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">, </span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">function</span><span style="color:#82AAFF"> named</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> NamedQueryResult</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> params</span><span style="color:#89DDFF"> =</span><span style="color:#F07178"> [</span><span style="color:#89DDFF">...</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">matchAll</span><span style="color:#F07178">(</span><span style="color:#89DDFF">/</span><span style="color:#C3E88D">:</span><span style="color:#89DDFF">([</span><span style="color:#C3E88D">a-zA-Z_</span><span style="color:#89DDFF">][</span><span style="color:#C3E88D">a-zA-Z0-9_</span><span style="color:#89DDFF">]*)/</span><span style="color:#F78C6C">g</span><span style="color:#F07178">)]</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">map</span><span style="color:#F07178">(</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">match</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =></span></span>
<span class="line"><span style="color:#BABED8">        match</span><span style="color:#F07178">[</span><span style="color:#F78C6C">0</span><span style="color:#F07178">]</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">slice</span><span style="color:#F07178">(</span><span style="color:#F78C6C">1</span><span style="color:#F07178">)</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#F07178">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> paramsSet</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Set</span><span style="color:#F07178">(</span><span style="color:#BABED8">params</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#C792EA">    const</span><span style="color:#BABED8"> paramArray</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> ParamType</span><span style="color:#F07178">[] </span><span style="color:#89DDFF">=</span><span style="color:#F07178"> []</span></span>
<span class="line"><span style="color:#C792EA">    let</span><span style="color:#BABED8"> idx</span><span style="color:#89DDFF"> =</span><span style="color:#F78C6C"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    for</span><span style="color:#F07178"> (</span><span style="color:#C792EA">const</span><span style="color:#BABED8"> param</span><span style="color:#89DDFF"> of</span><span style="color:#BABED8"> paramsSet</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> paramValue</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> args</span><span style="color:#F07178">[</span><span style="color:#BABED8">param</span><span style="color:#F07178">]</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> ===</span><span style="color:#89DDFF"> undefined</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            throw</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> MissingArgumentError</span><span style="color:#F07178">(</span><span style="color:#BABED8">param</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">Array</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">isArray</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#F07178">)) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#C792EA">            const</span><span style="color:#BABED8"> replaceValue</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> namedArray</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> idx</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#BABED8">            query</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">replaceAll</span><span style="color:#F07178">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">:</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">param</span><span style="color:#89DDFF">}`</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> replaceValue</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#BABED8">            paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#89DDFF">...</span><span style="color:#BABED8">paramValue</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#BABED8">            idx</span><span style="color:#89DDFF"> +=</span><span style="color:#BABED8"> paramValue</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">length</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            continue</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">        query</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">replaceAll</span><span style="color:#F07178">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">:</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">param</span><span style="color:#89DDFF">}`</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> `</span><span style="color:#C3E88D">$</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">idx</span><span style="color:#89DDFF">}`</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> ===</span><span style="color:#89DDFF"> null</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#BABED8">            paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#89DDFF">null</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> !=</span><span style="color:#89DDFF"> null</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF"> instanceof</span><span style="color:#FFCB6B"> Date</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#BABED8">                paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">toISOString</span><span style="color:#F07178">())</span></span>
<span class="line"><span style="color:#89DDFF">            }</span><span style="color:#89DDFF;font-style:italic"> else</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">                paramArray</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">push</span><span style="color:#F07178">(</span><span style="color:#BABED8">paramValue</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">toString</span><span style="color:#F07178">())</span></span>
<span class="line"><span style="color:#89DDFF">            }</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">        idx</span><span style="color:#89DDFF">++</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> NamedQueryResult</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">trim</span><span style="color:#F07178">()</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> paramArray</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> interface</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    query</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> values</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> any</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span></span>
<span class="line"><span style="color:#F07178">    namedQuery</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> DatabaseConfig</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">    public</span><span style="color:#C792EA"> readonly</span><span style="color:#F07178"> url</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">env</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Record</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">string</span><span style="color:#89DDFF">,</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">></span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> NodeJS</span><span style="color:#89DDFF">.</span><span style="color:#FFCB6B">ProcessEnv</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> conn</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> env</span><span style="color:#F07178">[</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">DATABASE_URL</span><span style="color:#89DDFF">"</span><span style="color:#F07178">]</span></span>
<span class="line"><span style="color:#82AAFF">        assert</span><span style="color:#F07178">(</span><span style="color:#BABED8">conn</span><span style="color:#89DDFF"> !=</span><span style="color:#89DDFF"> undefined</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">url</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> conn</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> Transaction</span><span style="color:#C792EA"> implements</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    #client</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> PoolClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">client</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> PoolClient</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> client</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> commit</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">commit</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> rollback</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">rollback</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    release</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">release</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    query</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> values</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> any</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> values</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">    namedQuery</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> named</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> args</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#client</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">preparedQuery</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">params</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">export</span><span style="color:#C792EA"> class</span><span style="color:#FFCB6B"> Database</span><span style="color:#C792EA"> implements</span><span style="color:#FFCB6B"> IDatabase</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#F07178">    #pool</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Pool</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    constructor</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">config</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> DatabaseConfig</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Pool</span><span style="color:#F07178">(</span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#F07178">            connectionString</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> config</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">url</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> ping</span><span style="color:#89DDFF">():</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">boolean</span><span style="color:#89DDFF">></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> result</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">select 1</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#BABED8"> result</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">rowCount</span><span style="color:#89DDFF"> ==</span><span style="color:#F78C6C"> 1</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    get</span><span style="color:#F07178"> conn</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#82AAFF">        assert</span><span style="color:#F07178">(</span><span style="color:#89DDFF">this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF"> !=</span><span style="color:#89DDFF"> null</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> transaction</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">callback</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">tx</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> Transaction</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =></span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">void</span><span style="color:#89DDFF">>)</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> handle</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">connect</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        await</span><span style="color:#BABED8"> handle</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">begin</span><span style="color:#89DDFF">"</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> tx</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> new</span><span style="color:#82AAFF"> Transaction</span><span style="color:#F07178">(</span><span style="color:#BABED8">handle</span><span style="color:#F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        try</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#82AAFF"> callback</span><span style="color:#F07178">(</span><span style="color:#BABED8">tx</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#BABED8"> tx</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">commit</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#89DDFF;font-style:italic"> catch</span><span style="color:#F07178"> (</span><span style="color:#BABED8">err</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            await</span><span style="color:#BABED8"> tx</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">rollback</span><span style="color:#F07178">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">            throw</span><span style="color:#BABED8"> err</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span><span style="color:#89DDFF;font-style:italic"> finally</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#BABED8">            tx</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">release</span><span style="color:#F07178">()</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">        }</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> query</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> any</span><span style="color:#BABED8">[]</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> args</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> namedQuery</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">query</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> string</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> args</span><span style="color:#89DDFF">:</span><span style="color:#FFCB6B"> NamedArgs</span><span style="color:#89DDFF">):</span><span style="color:#FFCB6B"> Promise</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">QueryResult</span><span style="color:#89DDFF">&#x3C;</span><span style="color:#FFCB6B">any</span><span style="color:#89DDFF">>></span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#C792EA">        const</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> named</span><span style="color:#F07178">(</span><span style="color:#BABED8">query</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> args</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#89DDFF;font-style:italic"> await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">query</span><span style="color:#F07178">(</span><span style="color:#BABED8">q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">preparedQuery</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> q</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">params</span><span style="color:#F07178">)</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    async</span><span style="color:#F07178"> disconnect</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        await</span><span style="color:#89DDFF"> this.</span><span style="color:#BABED8">#pool</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">end</span><span style="color:#F07178">()</span><span style="color:#89DDFF">;</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#89DDFF">}</span></span></code></pre> </div> </div> </div>  </div>  </main> <footer class="py-4 bg-gray-200 text-gray-500"> <div class="container max-w-6xl mx-auto px-6 lg:px-10">  <div class="flex"> <span class="text-sm mx-auto">© 2026 - Muhammad Moeen</span> </div>  </div> </footer> <div data-scrollbuttoncontainer class="transition-all duration-300 opacity-0 cursor-pointer"> <button data-scrollbutton title="Go To Top" class="fixed z-90 bottom-8 right-8 border-0 w-12 h-12 rounded-full drop-shadow-md bg-black text-white text-3xl font-bold"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 m-auto"> <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5"></path> </svg> </button> </div> <script src="/scripts/scrolltop.js" defer></script> </body></html>